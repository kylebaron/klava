---
title: "optimhelp"
author: "Kyle"
date: "April 1, 2016"
output: 
  md_document:
    variant: markdown_github
---

```{r,echo=FALSE}
knitr::opts_chunk$set(comment='.')

```


# optimhelp

```{r}
library(optimhelp)
```

So far, this is  a parameter management system.  I can name and set initial values
for parameters in a model.  In this example, I can also specify a transformation
for that parameter: the value is transformed to a different scale for estimation and 
it can be transformed back when either getting a prediction or after the optimization is finished.  

In this example, both `CL` and `VC` are estimated as log-transformed values.
```{r}
cl <- log_par("CL", 1.2)
vc <- log_par("VC", 22.3)
p <- new_pars(cl,vc)

```


After making a `pars` object, we can look at it
```{r}
p
```

or transform the starting values to the estimation scale
```{r}
start.values <- initials(p)
start.values
```

grafting back in gets us untransformed (by default)
```{r}
graft(p,start.values)
```



# Examples


## Simulate some data
```{r}
set.seed(292)

x <- runif(300,10,300)
y <- 0.9*x/(100+x)*exp(rnorm(length(x),0,sqrt(0.05)))
data <- data.frame(x=x,y=y)
head(data)

```

## Specify parameters
We will restrict emax to be between 0 and 1 for now.  Also sending a fixed 
parameter through for fun
```{r}
emax <- logit_par("emax", 0.6)
ec50 <- log_par("ec50", 60)
fx <- ident_par("yak", 1234, fixed=TRUE)
p <- new_pars(emax,ec50,fx)
p

```



## Fit with `optim`
```{r}

pred <- function(est,p, x) {
  est <- as.list(graft(p,est))
  yhat <- est$emax*x/(x+est$ec50)
  sqres <- (y-yhat)^2
  return(sum(sqres))
}



fit <-optim(par=initials(p),fn=pred,p=p,x=x)

untrans(graft(p,fit$par))

```




## Fit with `nls`
```{r}
prednls <- function(p, x, emax,ec50) {
  est <- as.list(untrans(graft(p,c(emax=emax,ec50=ec50))))
  yhat <- est$emax*x/(x+est$ec50)
  return(yhat)
}

fit <- nls(y~prednls(p=p,x=x,emax,ec50),data=data, start=initials(p))

fit

est <- graft(p,coef(fit))

coef(est)

coef(fit)
```






